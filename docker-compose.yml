version: "3.8"

services:
  echobridge:
    # Image will be automatically updated by GitHub Actions
    image: ghcr.io/korjavin/echobridge:latest
    container_name: echobridge
    
    # We use 'traefik_network' as per standard, or creates a default bridge if no traefik
    # Assuming user has a 'traefik_network' external network based on their description
    networks:
      - traefik_network

    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP router configuration
      # Uses HOSTNAME env var. If not set, user must set it in .env
      - "traefik.http.routers.echobridge.rule=Host(`${HOSTNAME}`)"
      - "traefik.http.routers.echobridge.entrypoints=websecure"
      - "traefik.http.routers.echobridge.tls.certresolver=myresolver"

      # Service configuration (specify backend port)
      - "traefik.http.services.echobridge.loadbalancer.server.port=3000"

    # Persistent data
    volumes:
      - ./data:/app/data
      - ./media:/app/media

    environment:
      - NODE_ENV=production
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      # EXTERNAL_URL is still useful for the bot logic, though Traefik handles the ingress
      - EXTERNAL_URL=https://${HOSTNAME} 
      - LOG_LEVEL=info

    restart: unless-stopped
    
    # Simple build context for local dev convenience, though CI uses image
    build: .

networks:
  traefik_network:
    name: traefik_network
    external: true
