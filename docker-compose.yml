version: "3.8"

services:
  echobridge:
    # Image will be automatically updated by GitHub Actions
    image: ghcr.io/korjavin/echobridge:4c2f8e85dfc478d3d664487a69d6c441b3e01b6e
    container_name: echobridge
    
    # Use dynamic network name from env var NETWORK, default to traefik_network
    networks:
      - traefik_network

    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"

      # HTTP router configuration
      # Uses HOSTNAME env var. If not set, user must set it in .env
      - "traefik.http.routers.echobridge.rule=Host(`${HOSTNAME}`)"
      - "traefik.http.routers.echobridge.entrypoints=websecure"
      - "traefik.http.routers.echobridge.tls.certresolver=myresolver"

      # Service configuration (specify backend port)
      - "traefik.http.services.echobridge.loadbalancer.server.port=3000"

    # Persistent data
    volumes:
      - ./data:/app/data
      - ./media:/app/media

    environment:
      - NODE_ENV=production
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      # EXTERNAL_URL is still useful for the bot logic, though Traefik handles the ingress
      - EXTERNAL_URL=https://${HOSTNAME} 
      - LOG_LEVEL=info

    restart: unless-stopped

networks:
  traefik_network:
    name: ${NETWORK:-traefik_network}
    external: true
