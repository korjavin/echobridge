AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  EchoBridge Alexa Skill Backend

  SAM Template for EchoBridge Alexa Skill Backend Service

Parameters:
  LwaClientId:
    Type: String
    Description: "Login with Amazon Client ID for proactive events"
  LwaClientSecret:
    Type: String
    NoEcho: true
    Description: "Login with Amazon Client Secret"
  CognitoUserPoolId:
    Type: String
    Description: "AWS Cognito User Pool ID for token validation"

Globals:
  Function:
    Timeout: 30

Resources:
  EchoBridgeAlexaSkillFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: index.handler
      Runtime: nodejs16.x
      Architectures:
        - x86_64
      Environment:
        Variables:
          LWA_CLIENT_ID: !Ref LwaClientId
          LWA_CLIENT_SECRET: !Ref LwaClientSecret
          ALEXA_EVENTS_ENDPOINT: https://api.amazonalexa.com/v1/proactiveEvents
          API_KEY: !Ref ApiKey
          COGNITO_USER_POOL_ID: !Ref CognitoUserPoolId
      Events:
        AlexaSkill:
          Type: AlexaSkill
        Api:
          Type: Api
          Properties:
            Path: /v1/message
            Method: post
            Auth:
              ApiKeyRequired: true

  ApiKey:
    Type: AWS::ApiGateway::ApiKey
    Properties:
      Name: EchoBridgeApiKey
      Enabled: true

  UsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: EchoBridgeUsagePlan
      ApiStages:
        - ApiId: !Ref ServerlessRestApi
          Stage: Prod
      Throttle:
        BurstLimit: 200
        RateLimit: 100

  UsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !Ref ApiKey
      KeyType: API_KEY
      UsagePlanId: !Ref UsagePlan

Outputs:
  EchoBridgeAlexaSkillApi:
    Description: "API Gateway endpoint URL for Prod stage for Echo Bridge Alexa Skill function"
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/v1/message/"
  EchoBridgeAlexaSkillFunction:
    Description: "Echo Bridge Alexa Skill Lambda Function ARN"
    Value: !GetAtt EchoBridgeAlexaSkillFunction.Arn
  EchoBridgeAlexaSkillFunctionIamRole:
    Description: "Implicit IAM Role created for Echo Bridge Alexa Skill function"
    Value: !GetAtt EchoBridgeAlexaSkillFunctionRole.Arn
  ApiKey:
    Description: "API Key for the EchoBridge API"
    Value: !Ref ApiKey
